<!DOCTYPE html>
<html>
<head>
  <title>Scratch</title>
</head>

<body>
  <h1>Meals (<span data-bind="text:test"></span>)</h1>
  
  <h2>Just Breakfasts:</h2>
  <ul data-bind="foreach: breakfasts">
    <li><span data-bind="text: id"></span> <select data-bind="event: { change: $parent.onMealTypeChange }, options: $parent.mealTypes, optionsCaption: 'Meal type', value: type"></select></li>
  </ul>
  <hr/>
  <h2>Meal-Types</h2>
  <ul data-bind="foreach: mealTypes">
    <li data-bind="text: $data, attr: {'data-collectionindex': $index}"></li>
  </ul>
  
  <p>Try adding some more stuff to the store: <span style="font-size: smaller; color: #888">'id' needs to be unique, for 'type' you can use an existing type or invent a new one</span></p>
  <p><input style="width: 32em; font-size: 0.9em; color: #050" data-bind="value: newMealJson"></textarea> <button data-bind="click: onAddMealClick">Add meal</button></p>
  
  <script type="text/javascript" src="./lib/require.js"></script>

  <script type="text/javascript">
    require.config(
      {
        baseUrl : '..',
        paths: {
          'dollar': './tests/lib/jquery',
          'store': '.',
          'promise': './lib/Promise',
          'knockout': './vendor/knockout',
          'lang': './vendor/lodash',
          'spec': './tests/spec'
        }
      }
    );
    require([
      //include all specs to be run
      'knockout',
      'lib/knockout.composeWith',
      'Memory',
      'Observable',
      'lang'
    ],
    
      function(ko, ko_composeWith, MemoryStore, Observable, lang) {

        var store = window.store = Observable( new MemoryStore({
          data: [
            { id: 'porridge', type: 'breakfast' },
            { id: 'muesli', type: 'breakfast' },
            { id: 'parkin', type: 'elevenses' }
          ]
        }));
        
        var allRecords = store.query(null);
        
        var viewModel = {
          test: ko.observable('test value'),
          breakfasts: store.query({ type: 'breakfast'}),
          newMealJson: ko.observable('{ "id": "pancakes", "type": "second-breakfast" }'),
          onAddMealClick: function(){
            try {
              console.log("meal JSON data: ", viewModel.newMealJson());
              var data= JSON.parse(viewModel.newMealJson());
              console.log("meal data: ", data);
            } catch(e){
              alert("Invalid meal object");
              return;
            }
            store.add( data );
          },
          onMealTypeChange: function(itemViewModel, evt){
            // one way to do "event-delegation" on non-observable properties from a live/observable array
            var selectElm = evt.target;
            // get the changed value from the DOM and DOM event
            var newValue = evt.target.options[ evt.target.selectedIndex ].value;
            // Knockout gives us the implicated viewModel (array item)
            // ... assign the new value, then update in the store
            itemViewModel.type = newValue;
            store.put(itemViewModel)
          },
          mealTypes: allRecords.extend({ 
            composeWith: [
              // logger('name field'), 
              curryPlucker('type'), 
              lang.uniq,
              logger('types') 
            ] 
          })
        };

        function curryPlucker(key) {
          return function(values) {
            return values.map(function(value){ 
              return value[key]; 
            });
          }
        }

        function logger(name) {
          return function(values) {
            console.log(name + " logger: got values: ", values);
            return values;
          };
        }

        viewModel.breakfasts.subscribe(function(resultsArray, details){
          console.log("Change to breakfasts results: ", details);
        });

        ko.applyBindings(viewModel);
        
      });
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Scratch</title>
</head>

<body>
  <h1>Seals (<span data-bind="text:test"></span>)</h1>
  <ul data-bind="foreach: breakfasts">
    <li><span data-bind="text: id"></span> <select data-bind="options: $parent.mealTypes, optionsCaption: 'Meal type', value: type"></select></li>
  </ul>
  <hr/>
  <h2>Types</h2>
  <ul data-bind="foreach: mealTypes">
    <li data-bind="text: $data, attr: {'data-collectionindex': $index}"></li>
  </ul>
  <script type="text/javascript" src="./lib/require.js"></script>

  <script type="text/javascript">
    require.config(
      {
        baseUrl : '..',
        paths: {
          'dollar': './tests/lib/zepto',
          'store': '.',
          'knockout': './vendor/knockout',
          'lang': './vendor/lodash',
          'spec': './tests/spec'
        }
      }
    );
    require([
      //include all specs to be run
      'knockout',
      'lib/knockout.composeWith',
      'Memory',
      'Observable',
      'lang'
    ],
    
      function(ko, ko_composeWith, MemoryStore, Observable, lang) {

        var store = window.store = Observable( new MemoryStore({
          data: [
            { id: 'porridge', type: 'breakfast' },
            { id: 'muesli', type: 'breakfast' },
            { id: 'parkin', type: 'elevenses' }
          ]
        }));
        
        var viewModel = {
          test: ko.observable('test value'),
          breakfasts: store.query({ type: 'breakfast'}),
          _allRecords: store.query(null), 
        };

        function curryPlucker(key) {
          return function(values) {
            return values.map(function(value){ 
              return value[key]; 
            });
          }
        }

        function logger(name) {
          return function(values) {
            console.log(name + " logger: got values: ", values);
            return values;
          };
        }

        viewModel.mealTypes = viewModel._allRecords.extend({ 
          composeWith: [
            // logger('name field'), 
            curryPlucker('type'), 
            lang.uniq,
            logger('types') 
          ] 
        });

        viewModel.breakfasts.subscribe(function(resultsArray, details){
          console.log("Change to breakfasts results: ", details);
        });

        ko.applyBindings(viewModel);
        
      });
  </script>
</body>
</html>
